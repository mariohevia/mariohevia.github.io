<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Flood Detection in Remote Sensing Images | Dr. Mario Hevia Fajardo</title> <meta name="author" content="Mario A. Hevia Fajardo"> <meta name="description" content="In this post, I explore how to implement flood detection models trained on drone imagery. Based on recent research using the BlessemFlood21 dataset, I walk through the process of preparing the dataset and training the neural networks."> <meta name="keywords" content="evolutionary-computation, evolutionary-algorithms, runtime-analysis, research, theory"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/icon.png"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://mariohevia.github.io/blog/2025/flood-detection/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Flood Detection in Remote Sensing Images",
      "description": "In this post, I explore how to implement flood detection models trained on drone imagery. Based on recent research using the BlessemFlood21 dataset, I walk through the process of preparing the dataset and training the neural networks.",
      "published": "May 2, 2025",
      "authors": [
        {
          "author": "Mario A. Hevia Fajardo",
          "authorURL": "https://mhevia.com",
          "affiliations": [
            {
              "name": "Unaffiliated",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Dr. Mario Hevia Fajardo</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right font-weight-bold" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">Home</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Flood Detection in Remote Sensing Images</h1> <p>In this post, I explore how to implement flood detection models trained on drone imagery. Based on recent research using the BlessemFlood21 dataset, I walk through the process of preparing the dataset and training the neural networks.</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#setting-up-the-environment">Setting Up the Environment</a></div> <div><a href="#dataset">Dataset</a></div> <div><a href="#deep-learning-model">Deep Learning Model</a></div> <div><a href="#training-the-model">Training the Model</a></div> <div><a href="#results">Results</a></div> <div><a href="#conclusion">Conclusion</a></div> </nav> </d-contents> <p>Climate change has increased the number and intensity of natural disasters worldwide, including across Europe. Among them, floods are particularly brutal. I had firsthand experience when my hometown flooded overnight, destroying houses and cars. Seeing it up close made the problem feel a lot less abstract.</p> <p>The good news is that technology has come a long way, and researchers are now working hard to build better tools for flood detection, which could help warn people and coordinate humanitarian aid during future flood events. Recently, I have been reading a few papers to understand how these systems work. But reading is not enough, so I decided to implement the ideas from these papers.</p> <p>In this post, I will use the <a href="https://arxiv.org/abs/2407.05007" rel="external nofollow noopener" target="_blank">BlessemFlood21</a> dataset for flood detection (semantic segmentation). The authors of the paper do not provide any code, so I will implement everything from scratch. Some of the decisions I make may differ from those made by the authors. All the code for this blog post can be found <a href="https://github.com/mariohevia/flood_detection_aug" rel="external nofollow noopener" target="_blank">here</a>.</p> <h3 id="setting-up-the-environment">Setting Up the Environment</h3> <p>The first thing we need to do is install the libraries we will be using. As always, I recommend creating a new environment first and installing everything inside it. Use the following commands to install the required packages:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uv venv envFloodDetect
<span class="nb">source </span>envFloodDetect/bin/activate
uv pip <span class="nb">install </span>torch torchvision matplotlib rasterio
</code></pre></div></div> <p>If you are not familiar with <code class="language-plaintext highlighter-rouge">uv</code> or don’t use it, you can install the packages with this instead:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> venv envFloodDetect
<span class="nb">source </span>envFloodDetect/bin/activate
pip <span class="nb">install </span>torch torchvision matplotlib rasterio
</code></pre></div></div> <p>We also need to download the dataset from <a href="https://fordatis.fraunhofer.de/handle/fordatis/379" rel="external nofollow noopener" target="_blank">https://fordatis.fraunhofer.de/handle/fordatis/379</a>.</p> <h3 id="dataset">Dataset</h3> <p>The imagery in the <a href="https://arxiv.org/abs/2407.05007" rel="external nofollow noopener" target="_blank">BlessemFlood21</a> dataset was acquired during the 2021 Erftstadt-Blessem flooding. It includes a georeferenced RGB image (~3.2 GB), supplemented with a water mask (~21.55 MB). To understand what it looks like, I opened it using QGIS (an open-source geographic information system software). Below, I show the complete image/dataset on the left and the mask overlaid on the image on the right.</p> <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;"> <img src="../../../assets/img/blog_images/2025-05-02-flood-detection/complete_dataset.png" alt="Complete dataset" style="max-width: 45%; height: auto;"> <img src="../../../assets/img/blog_images/2025-05-02-flood-detection/masked_dataset.png" alt="Masked dataset" style="max-width: 45%; height: auto;"> </div> <p>If you do not have QGIS, you will need to do all of this directly in Python. It’s important to keep in mind that the images are very large, and QGIS handles them efficiently by avoiding loading the entire image into RAM. It does this by opening the image at a lower resolution, using windows (i.e., clipping the image), or both.</p> <p>To replicate the outputs above, we need to do the same in Python (or load the entire image into RAM, which could cause problems). For this, I’ll use the <code class="language-plaintext highlighter-rouge">rasterio</code> library.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">rasterio</span>

<span class="c1"># Paths to the rgb and mask images
</span><span class="n">rgb_file_path</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../datasets/ortho_blessem_20210718_rgb.tif</span><span class="sh">'</span>
<span class="n">mask_file_path</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../datasets/ortho_blessem_20210718_mask.tif</span><span class="sh">'</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">rgb_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> \
    <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">mask_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_mask</span><span class="p">:</span>
    <span class="c1"># Check that the image and the mask are both the same size
</span>    <span class="k">assert</span> <span class="n">src_mask</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">src</span><span class="p">.</span><span class="n">width</span> <span class="ow">and</span> <span class="n">src_mask</span><span class="p">.</span><span class="n">height</span> <span class="o">==</span> <span class="n">src</span><span class="p">.</span><span class="n">height</span>

    <span class="c1"># Define the shape of the output to be read. It will use a lower resolution.
</span>    <span class="n">out_height</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">out_width</span> <span class="o">=</span> <span class="n">out_height</span> <span class="o">*</span> <span class="n">src</span><span class="p">.</span><span class="n">width</span> <span class="o">//</span> <span class="n">src</span><span class="p">.</span><span class="n">height</span> <span class="c1"># Maintains the aspect ratio
</span>    <span class="n">out_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">)</span>
    <span class="n">scaled_img</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">out_shape</span><span class="o">=</span><span class="n">out_shape</span><span class="p">)</span> <span class="c1"># Reads the image in low resolution
</span>    <span class="n">mask_out_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">)</span>
    <span class="n">scaled_mask</span> <span class="o">=</span> <span class="n">src_mask</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">out_shape</span><span class="o">=</span><span class="n">mask_out_shape</span><span class="p">)</span> <span class="c1"># Reads the mask in low resolution
</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Original image shape: (</span><span class="si">{</span><span class="n">src</span><span class="p">.</span><span class="n">width</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">src</span><span class="p">.</span><span class="n">height</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Scaled image shape: </span><span class="si">{</span><span class="n">scaled_img</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Transpose to HWC for matplotlib
</span>    <span class="n">scaled_img_plt</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="n">scaled_img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">scaled_mask_plt</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="n">scaled_mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div></div> <p>After plotting the loaded image we obtain the following.</p> <p style="text-align:center"><img src="../../../assets/img/blog_images/2025-05-02-flood-detection/initial_load.png" alt="Python image load" style="max-width: 100%; height: auto;"></p> <p>The first thing to notice is that the QGIS image and the Python-rendered image still do not look the same, the Python one appears brighter. This is because the image comes in <code class="language-plaintext highlighter-rouge">uint16</code> format instead of the standard <code class="language-plaintext highlighter-rouge">uint8</code> used by <code class="language-plaintext highlighter-rouge">matplotlib</code>. As a result, <code class="language-plaintext highlighter-rouge">matplotlib</code> clips any pixel values above <code class="language-plaintext highlighter-rouge">255</code> to <code class="language-plaintext highlighter-rouge">255</code>, making the image look overly bright.</p> <p>You might think that scaling from <code class="language-plaintext highlighter-rouge">0–65,535</code> to <code class="language-plaintext highlighter-rouge">0–255</code> (or <code class="language-plaintext highlighter-rouge">0–1</code>, since we plan to use it for deep learning) would solve the problem, and in theory, it would. But for this dataset, doing that results in an almost pitch-black image.</p> <p>This happens because the actual pixel values in the <code class="language-plaintext highlighter-rouge">uint16</code> image do not span the full range up to <code class="language-plaintext highlighter-rouge">65,535</code>. This is common in remote sensing and low-light imaging, where the dynamic range is often compressed. Following what the authors of the dataset did in their publication (and what QGIS does automatically), we normalise the pixel values using the 2nd and 98th percentiles.</p> <p>To compute the percentiles, we have three options: load the entire image at once, load the image in small parts (tiles), or use the lower-resolution version to compute them. I believe that using the lower-resolution version is sufficient most of the time, but to confirm this for this dataset, I also loaded the full-resolution image and compared the results.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">rgb_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1">### WARNING: This uses a lot of RAM ###
</span>    <span class="c1"># Read all the image bands (band 1=R, 2=G, 3=B)
</span>    <span class="n">r</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Calculate 2nd and 98th percentiles for each band/channel
</span>    <span class="n">p2_r</span><span class="p">,</span> <span class="n">p98_r</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">])</span>
    <span class="n">p2_g</span><span class="p">,</span> <span class="n">p98_g</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">])</span>
    <span class="n">p2_b</span><span class="p">,</span> <span class="n">p98_b</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">98</span><span class="p">])</span>

    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Red 2nd and 98th percentiles: </span><span class="si">{</span><span class="n">p2_r</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">p98_r</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Green 2nd and 98th percentiles: </span><span class="si">{</span><span class="n">p2_g</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">p98_g</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Blue 2nd and 98th percentiles: </span><span class="si">{</span><span class="n">p2_b</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">p98_b</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Using the scaled image with lower resolution
</span>    <span class="n">percentiles_2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">scaled_img</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">percentiles_98</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">scaled_img</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">2nd percentiles: </span><span class="si">{</span><span class="n">percentiles_2</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">98th percentiles: </span><span class="si">{</span><span class="n">percentiles_98</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p>This prints the following results.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Red 2nd and 98th percentiles: 0.0, 516.0
Green 2nd and 98th percentiles: 0.0, 465.0
Blue 2nd and 98th percentiles: 0.0, 293.0
2nd percentiles: [0. 0. 0.]
98th percentiles: [515. 465. 294.]
</code></pre></div></div> <p>By using these percentiles to normalise the image, we finally obtain a good image that looks similar to the one from QGIS.</p> <p style="text-align:center"><img src="../../../assets/img/blog_images/2025-05-02-flood-detection/final_load.png" alt="Python image load" style="max-width: 60%; height: auto;"></p> <p>The last thing we need to be able to do is load matching tiles from both the dataset image and the mask, so that we can use them for training and testing. Here, I load a random tile, but later on we will load them based on a grid to avoid repeating images or using parts of the training images in testing.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">rasterio.windows</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">rgb_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> \
    <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">mask_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_mask</span><span class="p">:</span>

    <span class="c1"># Obtaining percentiles with low resolution image
</span>    <span class="n">out_height</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">out_width</span> <span class="o">=</span> <span class="n">out_height</span> <span class="o">*</span> <span class="n">src</span><span class="p">.</span><span class="n">width</span> <span class="o">//</span> <span class="n">src</span><span class="p">.</span><span class="n">height</span>  <span class="c1"># Maintains the aspect ratio
</span>    <span class="n">out_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">)</span>
    <span class="n">scaled_img</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">out_shape</span><span class="o">=</span><span class="n">out_shape</span><span class="p">)</span>  <span class="c1"># Reads the image in low resolution
</span>    <span class="n">percentiles_2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">scaled_img</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Shape: (3, 1, 1)
</span>    <span class="n">percentiles_98</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">scaled_img</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Shape: (3, 1, 1)
</span>
    <span class="c1"># Loading a random tile of size 512x512
</span>    <span class="n">tile_size</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">x_start</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">tile_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y_start</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">tile_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="nc">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">)</span>

    <span class="c1"># Read the RGB tile - will be in (C,H,W) format
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>  <span class="c1"># Shape: (3, 512, 512)
</span>
    <span class="c1"># Normalise and clip (applying to each channel)
</span>    <span class="n">final_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">percentiles_2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">percentiles_98</span> <span class="o">-</span> <span class="n">percentiles_2</span><span class="p">)</span>
    <span class="n">final_img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">final_img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Read the mask tile - will be in (C,H,W) format
</span>    <span class="n">mask_image</span> <span class="o">=</span> <span class="n">src_mask</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">image</span><span class="sh">'</span><span class="p">:</span> <span class="n">final_img</span><span class="p">,</span> <span class="sh">'</span><span class="s">mask</span><span class="sh">'</span><span class="p">:</span> <span class="n">mask_image</span><span class="p">}</span>
</code></pre></div></div> <p>Displaying the results we get these matching tiles.</p> <p style="text-align:center"><img src="../../../assets/img/blog_images/2025-05-02-flood-detection/tiles.png" alt="Python image load" style="max-width: 100%; height: auto;"></p> <h3 id="deep-learning-model">Deep Learning Model</h3> <p>Following <a href="https://arxiv.org/abs/2407.05007" rel="external nofollow noopener" target="_blank">Polushko et al. (2024)</a> and <a href="https://arxiv.org/abs/2504.20203" rel="external nofollow noopener" target="_blank">Polushko et al. (2025)</a> I will use the DeepLabV3+ (<a href="https://link.springer.com/chapter/10.1007/978-3-030-01234-2_49" rel="external nofollow noopener" target="_blank">Chen et al. (2018)</a>) model with <code class="language-plaintext highlighter-rouge">SE-ResNet50</code> encoder with 26M parameters, pretrained with <code class="language-plaintext highlighter-rouge">ImageNet</code>. To use this model I use the <a href="https://github.com/qubvel-org/segmentation_models.pytorch" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">segmentation-models-pytorch</code></a>. To install it you can run the following command.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uv pip <span class="nb">install </span>segmentation-models-pytorch
</code></pre></div></div> <p>Then you can import the model I will be using with this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">segmentation_models_pytorch</span> <span class="k">as</span> <span class="n">smp</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">smp</span><span class="p">.</span><span class="nc">DeepLabV3Plus</span><span class="p">(</span>
    <span class="n">encoder_name</span><span class="o">=</span><span class="sh">"</span><span class="s">se_resnet50</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoder_weights</span><span class="o">=</span><span class="sh">"</span><span class="s">imagenet</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Binary segmentation
</span>    <span class="n">activation</span><span class="o">=</span><span class="sh">"</span><span class="s">sigmoid</span><span class="sh">"</span>
<span class="p">)</span>
</code></pre></div></div> <p>There are some other things to consider for this model. First, the model expects tensors with the shape <code class="language-plaintext highlighter-rouge">(batch_size, channels, height, width)</code>, and it relies on pixel values being normalised using specific ImageNet statistics: a mean of <code class="language-plaintext highlighter-rouge">[0.485, 0.456, 0.406]</code> and a standard deviation of <code class="language-plaintext highlighter-rouge">[0.229, 0.224, 0.225]</code>. Assuming that <code class="language-plaintext highlighter-rouge">final_img</code> comes from the code in the last section, we can adjust the image with the following:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Normalise and transform to tensor for DL model
</span><span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">preprocessed_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_img</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
<span class="n">tensor_img</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">preprocessed_img</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>
</code></pre></div></div> <p>Next, we can go ahead and create an inference function, although it will not return any useful results yet, since the model has not been trained yet.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="sh">"</span><span class="s">cuda</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># Preprocess
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Add batch dimension
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># Inference
</span>    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prediction</span>  <span class="c1"># Values between 0-1 for binary segmentation
</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="nf">predict</span><span class="p">(</span><span class="n">tensor_img</span><span class="p">)</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>

<span class="c1"># Transform for matplotlib
</span><span class="n">prediction_plt</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div></div> <p style="text-align:center"><img src="../../../assets/img/blog_images/2025-05-02-flood-detection/untrained_prediction.png" alt="Untrained prediction" style="max-width: 100%; height: auto;"></p> <h3 id="training-the-model">Training the Model</h3> <p>To train the model, we first need to create a <code class="language-plaintext highlighter-rouge">Dataset</code> class from <code class="language-plaintext highlighter-rouge">torch.utils.data</code> to load the image into small tiles, normalise them, and everything we did in the <a href="#dataset">Dataset</a> section. This is a bit more complicated (and lengthy), so I will describe the code briefly, and you can review it at your own pace below.</p> <p>I created the <code class="language-plaintext highlighter-rouge">TiledDataset</code> class, which takes the two <code class="language-plaintext highlighter-rouge">.tif</code> files and can output several tiles in batches using <code class="language-plaintext highlighter-rouge">DataLoader</code>. When the class is initialised, it first computes the 2nd and 98th percentile values from the image, just as we did before. Then, it creates a list of all the top-left coordinates of each tile, checking whether the mask indicates the presence of water and ensuring that the tile is not completely black. Afterward, it splits the data into training, validation, and testing sets (80% - 10% - 10%), ensuring that each split contains a proportional number of water-containing tiles for diversity across the subsets.</p> <p>When requesting an image from the class, it takes the top-left coordinates of the tile, loads the image, and normalises it first with the percentiles, then based on the ImageNet statistics to make our data compatible with the pre-trained encoder.</p> <div class="code-container"> <input type="checkbox" id="code-toggle-2" class="code-toggle-control"> <label for="code-toggle-2" class="code-toggle-label">Dataset Code</label> <div class="code-content"> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="c1"># dataset.py
</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">random_split</span>
<span class="kn">import</span> <span class="n">rasterio</span>
<span class="kn">from</span> <span class="n">rasterio.windows</span> <span class="kn">import</span> <span class="n">Window</span>

<span class="k">class</span> <span class="nc">TiledDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Dataset that loads tiles from large TIFF files using Rasterio.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> 
        <span class="n">rgb_file</span><span class="p">,</span> 
        <span class="n">mask_file</span><span class="p">,</span> 
        <span class="n">tile_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> 
        <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
        <span class="n">subset</span><span class="o">=</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">,</span> 
        <span class="n">test_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
        <span class="n">val_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
        <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">tile_coords</span><span class="o">=</span><span class="bp">None</span>
        <span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Args:
            rgb_file (string): Path to the large RGB .tif file.
            mask_file (string): Path to the large mask .tif file.
            tile_size (int, optional): Size of the square tiles to extract (e.g., 512).
            transform (callable, optional): Optional transform to be applied on a sample.
            subset (string, optional): What type of dataset is required (</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">val</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="s">)
            test_ratio (float, optional): Ratio of the dataset to use for testing (between 0 and 1).
            val_ratio (float, optional): Ratio of the dataset to use for validation (between 0 and 1).
            seed (int, optional): Seed for sampling the train/test subsets.
            tile_coords (numpy, optional): Optional array of tile coordinates.
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rgb_file</span> <span class="o">=</span> <span class="n">rgb_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mask_file</span> <span class="o">=</span> <span class="n">mask_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tile_size</span> <span class="o">=</span> <span class="n">tile_size</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rgb_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> \
            <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mask_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_mask</span><span class="p">:</span>

            <span class="k">assert</span> <span class="n">src_mask</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">src</span><span class="p">.</span><span class="n">width</span> <span class="ow">and</span> <span class="n">src_mask</span><span class="p">.</span><span class="n">height</span> <span class="o">==</span> <span class="n">src</span><span class="p">.</span><span class="n">height</span>

            <span class="c1"># Load a lower resolution version to compute the 2nd and 98th percentiles.
</span>            <span class="n">out_height</span> <span class="o">=</span> <span class="mi">512</span>
            <span class="n">out_width</span> <span class="o">=</span> <span class="n">out_height</span> <span class="o">*</span> <span class="n">src</span><span class="p">.</span><span class="n">width</span> <span class="o">//</span> <span class="n">src</span><span class="p">.</span><span class="n">height</span> <span class="c1"># Maintains the aspect ratio
</span>            <span class="n">out_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">out_height</span><span class="p">,</span> <span class="n">out_width</span><span class="p">)</span>
            <span class="n">scaled_img</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">out_shape</span><span class="o">=</span><span class="n">out_shape</span><span class="p">)</span> <span class="c1"># Reads the image in low resolution
</span>
            <span class="n">self</span><span class="p">.</span><span class="n">percentiles_2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">scaled_img</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">percentiles_98</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">scaled_img</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">rgb_width</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">width</span>
            <span class="n">self</span><span class="p">.</span><span class="n">rgb_height</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">height</span>
            <span class="n">self</span><span class="p">.</span><span class="n">mask_width</span> <span class="o">=</span> <span class="n">src_mask</span><span class="p">.</span><span class="n">width</span>
            <span class="n">self</span><span class="p">.</span><span class="n">mask_height</span> <span class="o">=</span> <span class="n">src_mask</span><span class="p">.</span><span class="n">height</span>

        <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span> <span class="o">=</span> <span class="n">tile_coords</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_create_tile_coords</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">water_tile_coords</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">non_water_tile_coords</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Create controlled splits
</span>        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">torch</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">test_ratio</span><span class="o">-</span><span class="n">val_ratio</span><span class="p">,</span> <span class="n">val_ratio</span><span class="p">,</span> <span class="n">test_ratio</span><span class="p">]</span>
        <span class="n">water_train</span><span class="p">,</span> <span class="n">water_val</span><span class="p">,</span> <span class="n">water_test</span> <span class="o">=</span> <span class="nf">random_split</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">water_tile_coords</span><span class="p">,</span> <span class="n">ratios</span><span class="p">)</span>
        <span class="n">non_water_train</span><span class="p">,</span> <span class="n">non_water_val</span><span class="p">,</span> <span class="n">non_water_test</span> <span class="o">=</span> <span class="nf">random_split</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">non_water_tile_coords</span><span class="p">,</span> <span class="n">ratios</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">torch</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">initial_seed</span><span class="p">())</span>
        <span class="k">match</span> <span class="n">subset</span><span class="p">:</span>
            <span class="k">case</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span> <span class="o">=</span> <span class="n">water_train</span> <span class="o">+</span> <span class="n">non_water_train</span>
            <span class="k">case</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span> <span class="o">=</span> <span class="n">water_test</span> <span class="o">+</span> <span class="n">non_water_test</span>
            <span class="k">case</span> <span class="sh">'</span><span class="s">val</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span> <span class="o">=</span> <span class="n">water_val</span> <span class="o">+</span> <span class="n">non_water_val</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown subset </span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_tile_coords</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">non_water_tile_coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">water_tile_coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rgb_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> \
                <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mask_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_mask</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x_start</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_size</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">y_start</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_size</span><span class="p">):</span>
                        <span class="c1"># Define the window (tile)
</span>                        <span class="n">window</span> <span class="o">=</span> <span class="nc">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_size</span><span class="p">)</span>
                        <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">src_mask</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
                        <span class="nf">match </span><span class="p">(</span><span class="nf">bool</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="n">image</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)),</span> <span class="nf">bool</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))):</span>
                            <span class="nf">case </span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span> <span class="c1"># The mask is all black but not the tile
</span>                                <span class="n">non_water_tile_coords</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">))</span>
                            <span class="nf">case </span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span> <span class="c1"># Both the tile and the mask are not all black
</span>                                <span class="n">water_tile_coords</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">))</span>
                            <span class="nf">case </span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">The tile is all black but the mask indicates water</span><span class="sh">"</span><span class="p">)</span>
                            <span class="nf">case </span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span> <span class="c1"># Both the tile and the mask are all black
</span>                                <span class="k">pass</span>
                        <span class="c1"># if len(water_tile_coords)&gt;1 and len(non_water_tile_coords)&gt;1:
</span>                        <span class="c1">#     break
</span>                <span class="n">tile_coords</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">non_water_tile_coords</span><span class="p">]</span> <span class="o">+</span> 
                    <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">water_tile_coords</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">tile_coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">np</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">'</span><span class="s">../datasets/tile_coords.npy</span><span class="sh">'</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">normalise_tile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tile</span><span class="p">):</span>
        <span class="c1"># Normalise and clip
</span>        <span class="n">tile</span> <span class="o">=</span> <span class="p">(</span><span class="n">tile</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">percentiles_2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">percentiles_98</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">percentiles_2</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Normalise for ImageNet and turn into tensor
</span>        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">preprocessed_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        <span class="n">tensor_img</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">preprocessed_img</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">tensor_img</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="c1"># Get the top-left coordinates of the idx tile
</span>        <span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tile_coords</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Define the window (tile) to read
</span>        <span class="n">window</span> <span class="o">=</span> <span class="nc">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tile_size</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rgb_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> \
            <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">mask_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_mask</span><span class="p">:</span>
            <span class="c1"># Read the RGB tile
</span>            <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">tensor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">normalise_tile</span><span class="p">(</span><span class="n">rgb_image</span><span class="p">)</span>

            <span class="c1"># Read the mask tile
</span>            <span class="n">mask_image</span> <span class="o">=</span> <span class="n">src_mask</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">image</span><span class="sh">'</span><span class="p">:</span><span class="n">image</span><span class="p">,</span> <span class="sh">'</span><span class="s">tensor</span><span class="sh">'</span><span class="p">:</span><span class="n">tensor</span><span class="p">,</span> <span class="sh">'</span><span class="s">mask</span><span class="sh">'</span><span class="p">:</span><span class="n">mask_image</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">transformed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="o">**</span><span class="n">sample</span><span class="p">)</span>
            <span class="n">sample</span><span class="p">[</span><span class="sh">'</span><span class="s">image</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformed</span><span class="p">[</span><span class="sh">'</span><span class="s">image</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">sample</span><span class="p">[</span><span class="sh">'</span><span class="s">tensor</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformed</span><span class="p">[</span><span class="sh">'</span><span class="s">tensor</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">sample</span><span class="p">[</span><span class="sh">'</span><span class="s">mask</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformed</span><span class="p">[</span><span class="sh">'</span><span class="s">mask</span><span class="sh">'</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">sample</span>
</code></pre></div> </div> </div> </div> <p>Once we have the dataset ready, we can train the neural network. Once again, this involves quite a bit of code, but it follows a fairly standard training procedure once the dataset is loaded. I include the code below for completeness, but I will not explain it further.</p> <div class="code-container"> <input type="checkbox" id="code-toggle-1" class="code-toggle-control"> <label for="code-toggle-1" class="code-toggle-label">Training Code</label> <div class="code-content"> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="c1"># train_model.py
</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="n">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="n">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="n">segmentation_models_pytorch</span> <span class="k">as</span> <span class="n">smp</span>
<span class="kn">from</span> <span class="n">dataset</span> <span class="kn">import</span> <span class="n">TiledDataset</span>  <span class="c1"># Assuming you saved the dataset code in dataset.py
</span>
<span class="c1"># Paths
</span><span class="n">RGB_FILE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../datasets/ortho_blessem_20210718_rgb.tif</span><span class="sh">'</span>
<span class="n">MASK_FILE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../datasets/ortho_blessem_20210718_mask.tif</span><span class="sh">'</span>
<span class="n">TILE_COORDS_PATH</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../datasets/tile_coords.npy</span><span class="sh">'</span>
<span class="n">SAVE_PATH</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../models/deeplabv3plus_best.pth</span><span class="sh">'</span>

<span class="c1"># Parameters
</span><span class="n">TILE_SIZE</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">NUM_EPOCHS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">LR</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cuda</span><span class="sh">'</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">)</span>
<span class="n">SEED</span> <span class="o">=</span> <span class="mi">2025</span>
<span class="n">TEST_RATIO</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="k">def</span> <span class="nf">get_dataloaders</span><span class="p">():</span>
    <span class="n">tile_coords</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">TILE_COORDS_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">TILE_COORDS_PATH</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="nc">TiledDataset</span><span class="p">(</span>
        <span class="n">rgb_file</span><span class="o">=</span><span class="n">RGB_FILE</span><span class="p">,</span>
        <span class="n">mask_file</span><span class="o">=</span><span class="n">MASK_FILE</span><span class="p">,</span>
        <span class="n">tile_size</span><span class="o">=</span><span class="n">TILE_SIZE</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">subset</span><span class="o">=</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">test_ratio</span><span class="o">=</span><span class="n">TEST_RATIO</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span>
        <span class="n">tile_coords</span><span class="o">=</span><span class="n">tile_coords</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">val_dataset</span> <span class="o">=</span> <span class="nc">TiledDataset</span><span class="p">(</span>
        <span class="n">rgb_file</span><span class="o">=</span><span class="n">RGB_FILE</span><span class="p">,</span>
        <span class="n">mask_file</span><span class="o">=</span><span class="n">MASK_FILE</span><span class="p">,</span>
        <span class="n">tile_size</span><span class="o">=</span><span class="n">TILE_SIZE</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">subset</span><span class="o">=</span><span class="sh">'</span><span class="s">val</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">test_ratio</span><span class="o">=</span><span class="n">TEST_RATIO</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span>
        <span class="n">tile_coords</span><span class="o">=</span><span class="n">tile_coords</span>
    <span class="p">)</span>

    <span class="n">test_dataset</span> <span class="o">=</span> <span class="nc">TiledDataset</span><span class="p">(</span>
        <span class="n">rgb_file</span><span class="o">=</span><span class="n">RGB_FILE</span><span class="p">,</span>
        <span class="n">mask_file</span><span class="o">=</span><span class="n">MASK_FILE</span><span class="p">,</span>
        <span class="n">tile_size</span><span class="o">=</span><span class="n">TILE_SIZE</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">subset</span><span class="o">=</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">test_ratio</span><span class="o">=</span><span class="n">TEST_RATIO</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span>
        <span class="n">tile_coords</span><span class="o">=</span><span class="n">tile_coords</span>
    <span class="p">)</span>

    <span class="n">train_loader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">val_loader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="nf">get_dataloaders</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">smp</span><span class="p">.</span><span class="nc">DeepLabV3Plus</span><span class="p">(</span>
        <span class="n">encoder_name</span><span class="o">=</span><span class="sh">"</span><span class="s">se_resnet50</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoder_weights</span><span class="o">=</span><span class="sh">"</span><span class="s">imagenet</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="bp">None</span>  <span class="c1"># Use with BCEWithLogitsLoss
</span>    <span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BCEWithLogitsLoss</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">)</span>

    <span class="n">best_loss</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="sh">'</span><span class="s">inf</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">NUM_EPOCHS</span><span class="p">):</span>
        <span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Epoch [</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">NUM_EPOCHS</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">loop</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">tensor</span><span class="sh">'</span><span class="p">].</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">mask</span><span class="sh">'</span><span class="p">].</span><span class="nf">float</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>  <span class="c1"># Shape: (B, 1, H, W)
</span>            <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">masks</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">masks</span>  <span class="c1"># Handle single-channel
</span>
            <span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">).</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Output shape: (B, H, W)
</span>            <span class="n">loss</span> <span class="o">=</span> <span class="nf">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>
            <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>

            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">()</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">())</span>

        <span class="n">avg_train_loss</span> <span class="o">=</span> <span class="n">train_loss</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> - Average Training Loss: </span><span class="si">{</span><span class="n">avg_train_loss</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Evaluate on test set
</span>        <span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
        <span class="n">test_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">tensor</span><span class="sh">'</span><span class="p">].</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">mask</span><span class="sh">'</span><span class="p">].</span><span class="nf">float</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">).</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="nf">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>
                <span class="n">test_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">()</span>
        <span class="n">avg_test_loss</span> <span class="o">=</span> <span class="n">test_loss</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> - Average Test Loss: </span><span class="si">{</span><span class="n">avg_test_loss</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Save best model
</span>        <span class="k">if</span> <span class="n">avg_test_loss</span> <span class="o">&lt;</span> <span class="n">best_loss</span><span class="p">:</span>
            <span class="n">best_loss</span> <span class="o">=</span> <span class="n">avg_test_loss</span>
            <span class="n">torch</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">(),</span> <span class="n">SAVE_PATH</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Saved new best model at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> with loss </span><span class="si">{</span><span class="n">best_loss</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">train</span><span class="p">()</span>
</code></pre></div> </div> </div> </div> <h3 id="results">Results</h3> <p>After training, the model showed promising results on the validation set. I still needed to evaluate it on the test set, as the models were selected based on their validation performance. Using IoU, Dice, and accuracy as metrics, the model achieved an average IoU of 89.99%, a Dice score of 94.73%, and an accuracy of 99.56%. These results indicate strong performance in both segmentation quality and pixel-wise classification. Interestingly, the model appears to outperform what is reported in <a href="https://arxiv.org/abs/2407.05007" rel="external nofollow noopener" target="_blank">Polushko et al. (2024)</a> and <a href="https://arxiv.org/abs/2504.20203" rel="external nofollow noopener" target="_blank">Polushko et al. (2025)</a>; however, since these papers do not share their code, it’s difficult to determine what changes may have led to the performance difference.</p> <p>Once again, the code for testing is fairly straightforward, so I will not explain it. But, I will share an image showing the predicted mask (middle) versus the real mask (right).</p> <div class="code-container"> <input type="checkbox" id="code-toggle-3" class="code-toggle-control"> <label for="code-toggle-3" class="code-toggle-label">Testing Code</label> <div class="code-content"> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="n">segmentation_models_pytorch</span> <span class="k">as</span> <span class="n">smp</span>
<span class="kn">from</span> <span class="n">segmentation_models_pytorch.metrics</span> <span class="kn">import</span> <span class="n">get_stats</span><span class="p">,</span> <span class="n">iou_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy</span>
<span class="kn">from</span> <span class="n">dataset</span> <span class="kn">import</span> <span class="n">TiledDataset</span>
<span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Paths
</span><span class="n">RGB_FILE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../datasets/ortho_blessem_20210718_rgb.tif</span><span class="sh">'</span>
<span class="n">MASK_FILE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../datasets/ortho_blessem_20210718_mask.tif</span><span class="sh">'</span>
<span class="n">TILE_COORDS_PATH</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../datasets/tile_coords.npy</span><span class="sh">'</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../models/deeplabv3plus_best.pth</span><span class="sh">'</span>

<span class="c1"># Parameters
</span><span class="n">TILE_SIZE</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cuda</span><span class="sh">'</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">)</span>
<span class="n">SEED</span> <span class="o">=</span> <span class="mi">2025</span>
<span class="n">TEST_RATIO</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">VAL_RATIO</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">smp</span><span class="p">.</span><span class="nc">DeepLabV3Plus</span><span class="p">(</span>
    <span class="n">encoder_name</span><span class="o">=</span><span class="sh">"</span><span class="s">se_resnet50</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoder_weights</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">activation</span><span class="o">=</span><span class="bp">None</span>
<span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_test_loader</span><span class="p">():</span>
    <span class="n">tile_coords</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">TILE_COORDS_PATH</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">TILE_COORDS_PATH</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="n">test_dataset</span> <span class="o">=</span> <span class="nc">TiledDataset</span><span class="p">(</span>
        <span class="n">rgb_file</span><span class="o">=</span><span class="n">RGB_FILE</span><span class="p">,</span>
        <span class="n">mask_file</span><span class="o">=</span><span class="n">MASK_FILE</span><span class="p">,</span>
        <span class="n">tile_size</span><span class="o">=</span><span class="n">TILE_SIZE</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">subset</span><span class="o">=</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">test_ratio</span><span class="o">=</span><span class="n">TEST_RATIO</span><span class="p">,</span>
        <span class="n">val_ratio</span><span class="o">=</span><span class="n">VAL_RATIO</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span>
        <span class="n">tile_coords</span><span class="o">=</span><span class="n">tile_coords</span>
    <span class="p">)</span>

    <span class="n">test_loader</span> <span class="o">=</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_loader</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="nf">get_test_loader</span><span class="p">()</span>

    <span class="n">total_tp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_fp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_fn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_tn</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sh">"</span><span class="s">Evaluating</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">tensor</span><span class="sh">'</span><span class="p">].</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">mask</span><span class="sh">'</span><span class="p">].</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">uint8</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">masks</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">masks</span>

            <span class="n">outputs</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">).</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

            <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="nf">get_stats</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="n">total_tp</span> <span class="o">+=</span> <span class="n">tp</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
            <span class="n">total_fp</span> <span class="o">+=</span> <span class="n">fp</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
            <span class="n">total_fn</span> <span class="o">+=</span> <span class="n">fn</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
            <span class="n">total_tn</span> <span class="o">+=</span> <span class="n">tn</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>

    <span class="c1"># Compute metrics
</span>    <span class="n">iou</span> <span class="o">=</span> <span class="nf">iou_score</span><span class="p">(</span><span class="n">total_tp</span><span class="p">,</span> <span class="n">total_fp</span><span class="p">,</span> <span class="n">total_fn</span><span class="p">,</span> <span class="n">total_tn</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="sh">'</span><span class="s">micro</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">dice</span> <span class="o">=</span> <span class="nf">f1_score</span><span class="p">(</span><span class="n">total_tp</span><span class="p">,</span> <span class="n">total_fp</span><span class="p">,</span> <span class="n">total_fn</span><span class="p">,</span> <span class="n">total_tn</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="sh">'</span><span class="s">micro</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">total_tp</span><span class="p">,</span> <span class="n">total_fp</span><span class="p">,</span> <span class="n">total_fn</span><span class="p">,</span> <span class="n">total_tn</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="sh">'</span><span class="s">micro</span><span class="sh">'</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Average IoU: </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="n">iou</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Average Dice: </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="n">dice</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Average Accuracy: </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="n">acc</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div> </div> </div> </div> <p style="text-align:center"><img src="../../../assets/img/blog_images/2025-05-02-flood-detection/trained_prediction.png" alt="Untrained prediction" style="max-width: 100%; height: auto;"></p> <h3 id="conclusion">Conclusion</h3> <p>In this post, we built a complete pipeline for real-world flood detection using semantic segmentation. From preprocessing the images to creating a tile-based dataset and training a DeepLabV3+ model. I hope this walkthrough helped you better understand how semantic segmentation works; it certainly helped me to write it.</p> <p>One last note: based on the research papers I have read, data augmentation plays a crucial role in training effective semantic segmentation models. In this post, I did not apply any augmentation techniques, but I plan to explore that in a follow-up. I’m particularly interested in testing the effectiveness of augmentations inspired by <a href="https://arxiv.org/abs/2504.20203" rel="external nofollow noopener" target="_blank">Polushko et al. (2025)</a> and <a href="https://ieeexplore.ieee.org/document/9257710" rel="external nofollow noopener" target="_blank">Alharbi et al. (2020)</a>.</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2026 Mario A. Hevia Fajardo. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: February 03, 2026. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>